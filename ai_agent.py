import json
from config import AI_CONFIG
from openai import OpenAI
import streamlit as st


class AIAgent:
    def __init__(self):
        # 1. ç¡®ä¿ä» config è¯»å–
        self.api_key = AI_CONFIG.get("api_key")

        # 2. è‡ªåŠ¨ä¿®æ­£ URL (é˜²æ­¢ .env å¡«é”™)
        raw_url = AI_CONFIG.get("base_url", "https://api.deepseek.com")
        self.base_url = raw_url.split('/chat')[0].split('/v1')[0].rstrip('/')

        # 3. åˆå§‹åŒ– client
        self.client = OpenAI(
            api_key=self.api_key,
            base_url=self.base_url
        )
        self.model = AI_CONFIG.get("model", "deepseek-chat")

    def analyze_sentiment_and_tags(self, text, v_title="", v_desc="", is_sub_comment=False):
        """
        åˆ†ææƒ…æ„Ÿå’Œæ ‡ç­¾
        :param text: è¯„è®ºå†…å®¹
        :param is_sub_comment: æ˜¯å¦ä¸ºå­è¯„è®ºï¼ˆå›å¤ï¼‰
        """
        if not text or len(text.strip()) < 2:
            return {"score": 0.5, "label": "neutral", "tags": ["ç®€çŸ­å›å¤"]}

        if is_sub_comment:
            role_note = "ä½ ç°åœ¨æ­£åœ¨åˆ†æä¸€æ¡ã€å›å¤ä»–äººã€‘çš„å­è¯„è®ºã€‚"
            task_note = "è¯·é‡ç‚¹åˆ†æè¿™æ¡å›å¤æ˜¯åœ¨â€˜è¡¨ç¤ºè®¤åŒâ€™ã€â€˜åé©³äº‰åµâ€™è¿˜æ˜¯â€˜è¡¥å……è®¨è®ºâ€™ã€‚å¦‚æœæ˜¯å¯¹çº¿äº‰åµï¼Œæƒ…æ„Ÿåˆ†åº”åä½ã€‚"
        else:
            role_note = "ä½ ç°åœ¨æ­£åœ¨åˆ†æä¸€æ¡ã€ç›´æ¥è¯„ä»·è§†é¢‘ã€‘çš„ä¸»è¯„è®ºã€‚"
            task_note = "è¯·é‡ç‚¹åˆ†æè§‚ä¼—å¯¹è§†é¢‘å†…å®¹çš„æ€åº¦ï¼ˆå¦‚ï¼šå‚¬æ›´ã€èµç¾ã€åæ§½ã€å»ºè®®ï¼‰ã€‚"

        prompt = f"""
        ### è§’è‰²è®¾å®š
        ä½ æ˜¯ä¸€ä½æ·±è°™ B ç«™ï¼ˆBilibiliï¼‰ç¤¾åŒºæ–‡åŒ–ã€è¯­è¨€é£æ ¼åŠç”¨æˆ·å¿ƒç†çš„èµ„æ·±ç ”ç©¶å‘˜ã€‚ä½ è´Ÿè´£å¯¹è§†é¢‘è¯„è®ºè¿›è¡Œæ·±åº¦è¯­ä¹‰å®¡è®¡ï¼Œèƒ½å¤Ÿç²¾å‡†è¯†åˆ«åè®½ã€ç«‹åœºåå‘åŠç¤¾åŒºé»‘è¯ã€‚

        ### è§†é¢‘èƒŒæ™¯ä¸Šä¸‹æ–‡
        - **æ ‡é¢˜**ï¼š{v_title}
        - **ç®€ä»‹**ï¼š{v_desc}

        ### ä»»åŠ¡æ ¸å¿ƒé€»è¾‘
        åˆ†æå¾…å¤„ç†å†…å®¹ï¼Œå¹¶æŒ‰ä»¥ä¸‹ç»´åº¦åˆ¤å®šï¼šç›¸å…³æ€§ã€æƒ…æ„Ÿåˆ†å€¼ã€ææ€§æ ‡ç­¾ã€‚
        **ã€ä¸¥ç¦è¿‡åº¦ä½¿ç”¨â€œneutralâ€åˆ†ç±»ã€‘**ï¼šé™¤éå†…å®¹å®Œå…¨æ— æƒ…æ„Ÿè‰²å½©ï¼ˆå¦‚çº¯æ•°å­—ã€çº¯æ¬è¿æ—¶é—´è½´ï¼‰ï¼Œå¦åˆ™å¿…é¡»æŒ–æ˜æ½œåœ¨æƒ…ç»ªã€‚

        ---

        ### 1. è¯„åˆ†é˜¶æ¢¯ä¸å‡†åˆ™
        - **æåº¦ç§¯æ (0.85 - 1.0)**ï¼šå¼ºçƒˆèµç¾ã€ç»†èŠ‚è®¤å¯ã€ä¸‰è¿æ”¯æŒã€ç¡¬æ ¸å‚¬æ›´ã€‚
        - **å¾®æ­£å‘ (0.65 - 0.84)**ï¼šç®€å•è®¤å¯ï¼ˆå“ˆå“ˆã€ä¸é”™ï¼‰ã€ç¤¼è²Œæ‰“å¡ã€‚
        - **ç»å¯¹ä¸­ç«‹ (0.45 - 0.55)**ï¼šä»…é™çº¯äº‹å®é™ˆè¿°ï¼ˆ111ã€ç¬¬ä¸€ã€æŠ¥å¹•ï¼‰ã€‚
        - **å¾®è´Ÿå‘ (0.25 - 0.44)**ï¼šè½»å¾®åæ§½ã€å®¢è§‚é—æ†¾ï¼ˆè¦æ˜¯...å°±å¥½äº†ï¼‰ã€è°ƒä¾ƒå¼â€œä¸‹æ¬¡ä¸€å®šâ€ã€‚
        - **æåº¦æ¶ˆæ (0.0 - 0.24)**ï¼šäººèº«æ”»å‡»ã€å¼•æˆ˜è°©éª‚ã€æ·±åº¦åè®½ã€å½»åº•å¤±æœ›ã€‚

        ### 2. Bç«™è¯­å¢ƒå®¡è®¡è§„åˆ™
        - **è¯­ä¹‰è¯†åˆ«**ï¼šè¯†åˆ«â€˜ä¸‰è¿â€™/â€˜ä¿æŠ¤â€™(Pos)ã€â€˜ä¸‹æ¬¡ä¸€å®šâ€™(Neu/Neg)ã€â€˜[doge]â€™(åè®½/ä¸è´Ÿè´£ä»»çš„æˆè°‘)ã€‚
        - **ç«‹åœºå®¡è®¡ï¼ˆæ ¸å¿ƒï¼‰**ï¼š
            - **æ”¯æŒæ€§è¾©æŠ¤**ï¼šè‹¥è¯„è®ºè¯­æ°”æ¿€çƒˆï¼ˆåµæ¶ï¼‰ï¼Œä½†ç›®çš„æ˜¯åé©³é»‘ç²‰ã€ç»´æŠ¤è§†é¢‘è§‚ç‚¹æˆ–æ”¯æŒUPä¸»ï¼Œå¿…é¡»åˆ¤å®šä¸º **Positive**ï¼Œåˆ†å€¼ > 0.7ï¼Œæ ‡ç­¾ä¸ºâ€œç«‹åœºæŠ¤èˆªâ€ã€‚
            - **ç«‹åœºå…±é¸£**ï¼šè‹¥è¯„è®ºé€šè¿‡å¼ºè°ƒè´Ÿé¢äº‹å®ï¼ˆå¦‚ï¼šè¿™é‡Œç¡®å®å±é™©ï¼‰æ¥æ”¯æŒè§†é¢‘çš„æ‰¹åˆ¤æ€§ç«‹åœºï¼Œå¿…é¡»åˆ¤å®šä¸º **Positive**ï¼ˆç«‹åœºå…±é¸£ï¼‰ï¼Œè€Œéè´Ÿé¢æƒ…ç»ªã€‚
        - **åŠ›åº¦è°ƒèŠ‚**ï¼šå¹½é»˜ç©æ¢—åˆ†å€¼å‘ä¸­é—´æ”¶æ‹¢ï¼›æƒ…æ„Ÿå¼ºçƒˆçš„ï¼ˆæ„¤æ€’æˆ–ç‹‚å–œï¼‰å‘ 0 å’Œ 1 ä¸¤ææ¨å¼€ã€‚
       
        ### è¡Œä¸ºåˆ¤å®šè¡¥ä¸ï¼ˆæŠ—å¹²æ‰°é€»è¾‘ï¼‰ï¼š
            - **å»ä¼ªå­˜çœŸ**ï¼šB ç«™ç”¨æˆ·å¸¸ä½¿ç”¨åè¯­æˆ–æ¿€è¿›è¯æ±‡è¡¨è¾¾å–œçˆ±ï¼ˆå¦‚â€œè¿™è§†é¢‘å±…ç„¶æ˜¯å…è´¹èƒ½çœ‹çš„ï¼Ÿâ€ï¼‰ã€‚å¦‚æœè¯„è®ºè™½ç„¶è¯­æ°”æƒŠäººï¼Œä½†é€»è¾‘ä¸Šæ˜¯åœ¨èµç¾è§†é¢‘è´¨é‡ï¼Œè¯·åˆ¤å®šä¸º [èµèµ] è€Œé [åæ§½]ã€‚
            - **å¯¹çº¿ vs æ”»å‡»**ï¼š
                - å¦‚æœè¯„è®ºåœ¨é’ˆå¯¹è§†é¢‘çš„å…·ä½“è®ºç‚¹è¿›è¡Œè¾©è®ºï¼Œå³ä½¿è¯­æ°”ç”Ÿç¡¬ï¼Œä¹Ÿåº”å½’ç±»ä¸º [ç§‘æ™®] æˆ– [è´¨ç–‘]ï¼Œè€Œé [åæ§½]ã€‚
                - åªæœ‰å½“è¯„è®ºå†…å®¹ä¸è§†é¢‘ä¸»é¢˜æ— å…³ï¼Œä¸”çº¯ç²¹åœ¨è¿›è¡Œäººèº«æ”»å‡»æˆ–å¤è¯»è´Ÿé¢æƒ…ç»ªæ—¶ï¼Œæ‰å½’ç±»ä¸º [åæ§½]ã€‚
    
        ### emojiåˆ¤å®š
            åœ¨åˆ†æ B ç«™è¯„è®ºæ—¶ï¼Œè¯·ç‰¹åˆ«å…³æ³¨ä»¥ä¸‹è¡¨æƒ…é›†åˆçš„æ·±å±‚å«ä¹‰ï¼Œå®ƒä»¬å¯¹ sentiment_score æœ‰å†³å®šæ€§å½±å“ï¼š
            - æƒ…æ„Ÿæå€¼ä¿®æ­£ï¼šåŒ…å« [ç‚¹èµ] [å¤§ç¬‘] [æ‰“call] [æ˜Ÿæ˜Ÿçœ¼] [å‘œå‘œ](æ„Ÿä¼¤) æ—¶ï¼Œsentiment_score å¿…é¡» $\ge 0.85$ï¼›åŒ…å« [è¾£çœ¼ç›] [å] [æ— è¯­] [å«Œå¼ƒ] [å¤§éª‚] æ—¶ï¼Œåˆ†æ•°å¿…é¡» $\le 0.15$ã€‚
            - åè®½ä¸é€†å‘è¯­ä¹‰ï¼š[doge] ä¸ºæ ¸å¿ƒåè®½æ ‡è¯†ï¼Œè‹¥æ–‡å­—ä¸ºè¤’ä¹‰ä½†å¸¦ [doge]ï¼Œåˆ†æ•°ä¿®æ­£ä¸º $0.3$ (å˜²è®½)ï¼Œè‹¥å¸¦äº‰è®®æ€§æ–‡å­—åˆ™ä¿®æ­£ä¸º $0.5$ (å¼€ç©ç¬‘)ï¼›[æ»‘ç¨½] [ç¬‘å“­] [å¦™å•Š] [æœ‰ç‚¹æ„æ€] é¡»äº¤å‰éªŒè¯ä¸Šä¸‹æ–‡ï¼Œä¼˜å…ˆæ£€ç´¢åè¯­ç‰¹å¾ï¼Œè¯†åˆ«ä¸ºé˜´é˜³æ€ªæ°”æ—¶åˆ†å€¼å–è´Ÿã€‚
            - æ­£å‘è¯‰æ±‚è¯†åˆ«ï¼š[å¤§å“­] ä¸¥ç¦é»˜è®¤åˆ¤å®šä¸ºè´Ÿé¢ï¼Œè‹¥ä¼´éšâ€œæ±‚ã€æ›´ã€è¿˜è¦ã€å†æ¥ç‚¹â€ç­‰è¯ï¼Œè§†ä¸ºç§¯æè¯·æ±‚æˆ–éœ‡æ’¼å…±é¸£ï¼Œåˆ†å€¼å– $0.7 \sim 0.8$ï¼›[å‚²å¨‡] åˆ¤å®šä¸ºâ€œå˜´ç¡¬å¿ƒè½¯â€çš„æ­£é¢æƒ…æ„Ÿ ($0.7+$)ï¼›[æ­ªå˜´] åˆ¤å®šä¸ºçˆ½ç‚¹æ¢—ï¼Œåˆ†å€¼ææ­£ä¸”ç›¸å…³åº¦é«˜ã€‚
            - ä»·å€¼ä¸ç«‹åœºåˆ†æï¼š[æ€è€ƒ] [ç–‘é—®] [ç¬”è®°] ä»£è¡¨æ·±åº¦å‚ä¸ï¼Œrelevance_score é¡» $\ge 0.8$ï¼›[åƒç“œ] é”å®šæƒ…æ„Ÿåˆ†ä¸º $0.5$ å¹¶é™ä½ç›¸å…³åº¦ï¼Œè§†ä¸ºè·¯äººå›´è§‚ã€‚[è¾“å‡ºçº¦æŸ] è‹¥è¯†åˆ«åˆ°ä¸Šè¿°é€»è¾‘ï¼Œå¿…é¡»åœ¨ tags ä¸­ä½“ç°å¯¹åº”åˆ†ç±»ï¼ˆå¦‚ï¼šåè®½è¯­æ°”ã€ç§¯æè¯‰æ±‚ã€æ·±åº¦è®¨è®ºï¼‰ã€‚

        ### 3. ç¤ºä¾‹å‚è€ƒ (Few-Shot)
        - **ç¡¬æ ¸æ­£é¢**ï¼š"3åˆ†15ç§’å‰ªè¾‘ç»äº†ï¼Œè½¬åœºé€»è¾‘æ²¡è§è¿‡ã€‚" -> {{"score": 0.95, "label": "positive", "relevance": 0.98, "tags": ["åˆ›ä½œæŠ€æœ¯", "å…±é¸£", "ç¡¬æ ¸"]}}
        - **ç¡¬æ ¸åé¦ˆ**ï¼š"æ ‡é¢˜å†™AIç»˜ç”»ä½†å‚æ•°è®¾é”™äº†ï¼Œè¯¯å¯¼äººã€‚" -> {{"score": 0.25, "label": "negative", "relevance": 0.95, "tags": ["è§†é¢‘å†…å®¹", "è´¨ç–‘", "ç¡¬æ ¸"]}}
        - **ç«‹åœºæŠ¤èˆª**ï¼š"æ¥¼ä¸Šé»‘ç²‰çå—ï¼Ÿè®²è¿™ä¹ˆé€è¿˜æ ï¼Œæ»šï¼" -> {{"score": 0.8, "label": "positive", "relevance": 0.95, "tags": ["ç¤¾åŒºäº’åŠ¨", "èµèµ", "ç«‹åœºæŠ¤èˆª"]}}
        - **ç©æ¢—å‚¬æ›´**ï¼š"ç”Ÿäº§é˜Ÿçš„é©´éƒ½ä¸æ•¢è¿™ä¹ˆæ­‡ï¼Œé€Ÿæ›´ï¼" -> {{"score": 0.85, "label": "positive", "relevance": 0.65, "tags": ["åˆ›ä½œæŠ€æœ¯", "å‚¬æ›´", "ç©æ¢—"]}}
        - **çº¯æ°´åƒåœ¾**ï¼š"çœ‹æˆ‘åŠ¨æ€ï¼Œæœ‰æƒŠå–œã€‚" -> {{"score": 0.4, "label": "neutral", "relevance": 0.0, "tags": ["çº¯æƒ…ç»ªå‘æ³„", "åæ§½", "ç©æ¢—"]}}

        ---

        ### å¾…åˆ†æå†…å®¹
        "{text}"

        ---

        ### è¾“å‡ºçº¦æŸ
        å¿…é¡»ä¸¥æ ¼è¿”å›æ ‡å‡† JSONï¼Œç¦æ­¢ä»»ä½•è§£é‡Šè¯´æ˜ã€‚
        {{
            "score": 0.0-1.0,
            "label": "positive" | "neutral" | "negative",
            "relevance": 0.0-1.0 (è¯„è®ºä¸è§†é¢‘èƒŒæ™¯çš„ç›¸å…³æ€§),
            "tags": [
                "ä¸»é¢˜ï¼ˆä»[è§†é¢‘å†…å®¹, åˆ›ä½œæŠ€æœ¯, UPä¸»ä¸ªäºº, ç¤¾åŒºäº’åŠ¨, å¤–éƒ¨å…³è”, çº¯æƒ…ç»ªå‘æ³„]ä¸­é€‰ä¸€ï¼‰",
                "è¡Œä¸ºï¼ˆä»[è´¨ç–‘, å‚¬æ›´, ç§‘æ™®, å…±é¸£, èµèµ, åæ§½]ä¸­é€‰ä¸€ï¼‰",
                "ç‰¹å¾ï¼ˆå¦‚ï¼šç¡¬æ ¸, é˜´é˜³æ€ªæ°”, ç©æ¢—, çœŸè¯š, æ¿€è¿›, ç«‹åœºæŠ¤èˆªï¼‰"
            ]
        }}
        """

        try:
            if not self.api_key:
                return self._mock_analysis(text)

            # è°ƒç”¨ DeepSeek API
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªåªè¾“å‡º JSON çš„ä¸“ä¸šå†…å®¹åˆ†æåŠ©æ‰‹ã€‚"},
                    {"role": "user", "content": prompt}
                ],
                response_format={"type": "json_object"},
                timeout=15
            )

            res_content = response.choices[0].message.content
            return json.loads(res_content)

        except Exception as e:
            st.error(f"ğŸš¨ AI åˆ†æå¼‚å¸¸: {e}")
            return self._mock_analysis(text)

    def _mock_analysis(self, text):
        return {"score": 0.5, "label": "neutral", "tags": ["å¸¸è§„è¯„è®º"]}

agent = AIAgent()